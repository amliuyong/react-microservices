https://ticketing.dev/
`thisisunsafe`

# install ingress-nginx
```
 kubectl apply -f ingress-ngin-controller.yaml

 or 
 
 https://kubernetes.github.io/ingress-nginx/deploy/#docker-for-mac

```

http://ingress-nginx-controller.ingress-nginx.svc.cluster.local



```
sudo visudo

dayong-mac      ALL = (ALL) NOPASSWD: ALL
```

```
sudo vi /etc/hosts

127.0.0.1 ticketing.dev
```


# secret for jwt-secret
``
 kubectl create secret  generic jwt-secret --from-literal JWT_KEY=mykey123!
```

![](./jpg/overview.jpg)
![](./jpg/services.jpg)
![](./jpg/tables.jpg)
![](./jpg/events.jpg)

# Auth Service
![](./jpg/auth.jpg)
![](./jpg/auth_svc.jpg)
![](./jpg/auth_svc_detail.jpg)

# Shared Lib

```
 Create an public Organizations: yltickets
 https://www.npmjs.com/settings/yltickets/packages
 
 npm login
 npm publish --access public
 
 // use common 
 npm install @yltickets/common
 // update common to new version
 npm update @yltickets/common
 
```
https://github.com/amliuyong/react-microservices/tree/main/02_ticketing/common

![](./jpg/shared_lib.jpg)

# Tickets Service
![](./jpg/tickets_svc.jpg)
![](./jpg/tickets_svc_db.jpg)

# Nats Streaming Server

`kubectl port-forward nats-depl-b946946dd-2zns2 4222:4222`

`kubectl port-forward nats-depl-b946946dd-2zns2 8222:8222`

http://127.0.0.1:8222/streaming

http://127.0.0.1:8222/streaming/channelsz?subs=1

### Publish
```javascript
import nats from 'node-nats-streaming';

console.clear();

const stan = nats.connect('ticketing', 'abc', {
  url: 'http://localhost:4222',
});

stan.on('connect', () => {
  console.log('Publisher connected to NATS');

  const data = JSON.stringify({
    id: '123',
    title: 'concert',
    price: 20,
  });

  stan.publish('ticket:created', data, () => {
    console.log('Event published');
  });
});

```

### Listener

```javascript
import nats, {Message} from 'node-nats-streaming';
import {randomBytes} from 'crypto';

console.clear();

const clientId = randomBytes(8).toString('hex');
console.log(`clientId: ${clientId}`)
const stan = nats.connect('ticketing', clientId, {
    url: 'http://localhost:4222',
});

stan.on('connect', () => {
    console.log('Listener connected to NATS');

    stan.on('close', () => {
        console.log('NATS connection closed!');
        process.exit();
    });

    const options = stan
        .subscriptionOptions()
        .setManualAckMode(true)
        .setAckWait(20000)
        .setDeliverAllAvailable()
        .setDurableName('accounting-service');

    const subscription = stan.subscribe(
        'ticket:created',
        'queue-group-name',
        options
    );

    subscription.on('message', (msg: Message) => {
        const data = msg.getData();
        if (typeof data === 'string') {
            console.log(`Received event #${msg.getSequence()}, with data: ${data}`);
        }
        msg.ack();
    });
});

process.on('SIGINT', () => stan.close());
process.on('SIGTERM', () => stan.close());

```

# How to handle disorder event

## Last event processed tracked by resource ID

![](./jpg/how-to-handle-disorder-event.jpg)

## solution- use seq_id generated by Nats
![](./jpg/how-to-handle-disorder-event-traceOrder.jpg)
## solution - use continuous version id
![](./jpg/handle-event.jpg)
![](./jpg/handle-event-using-versions.jpg)